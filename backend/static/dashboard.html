<!DOCTYPE html>
<html lang="he" dir="rtl" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keylogger Monitoring Dashboard</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap');
    
    :root {
      --bs-body-font-family: 'Rubik', sans-serif;
      --bs-body-bg: #1a1a1a;
      --bs-tertiary-bg: #242424;
      --bs-border-color: #3a3a3a;
      --cyber-green: #00ff88; /* צבע ירוק סייברי */
    }

    body {
      background-color: var(--bs-body-bg);
    }
    
    .dashboard-header {
      border-bottom: 1px solid var(--bs-border-color);
      padding-bottom: 1rem;
    }

    .kpi-card {
      background-color: var(--bs-tertiary-bg);
      border: 1px solid var(--bs-border-color);
      transition: background-color 0.2s ease-in-out;
      height: 100%; /* גובה אחיד */
      min-height: 120px; /* גובה מינימלי */
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .kpi-card:hover {
      background-color: #2c2c2c;
    }
    .kpi-card .kpi-icon {
      font-size: 2rem;
      color: var(--cyber-green); /* ירוק סייברי */
      margin-bottom: 0.5rem;
    }
    .kpi-card .kpi-content {
      text-align: center;
      width: 100%;
    }
    .kpi-card .kpi-value {
      font-size: 1.5rem;
      font-weight: 500;
      margin-top: 0.25rem;
    }
    .kpi-card .kpi-label {
      font-size: 0.875rem;
      color: var(--bs-secondary);
      margin-bottom: 0.25rem;
    }
    
    .card {
       background-color: var(--bs-tertiary-bg);
       border: 1px solid var(--bs-border-color);
    }

    .table-hover tbody tr:hover {
      background-color: #2c2c2c;
    }

    /* FIX 2 HERE: Added a wrapper for the table to prevent jumping on refresh */
    .table-wrapper {
        min-height: 500px; /* This ensures the container doesn't collapse during loading */
    }
    
    .logs-table {
      font-size: 0.9rem;
    }
    .truncate {
      max-width: 350px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      direction: ltr;
      text-align: left;
    }

    .form-control, .form-select {
        background-color: #2c2c2c;
        border-color: var(--bs-border-color);
    }

    .form-control:focus, .form-select:focus {
        background-color: #303030;
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
    }
    
    .os-icon {
      font-size: 1.2rem;
      vertical-align: middle;
    }

    .badge {
        font-weight: 500;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const API_BASE = 'https://server-kodcode.droga.co.il';

    // פונקציות API (ללא שינוי)
    const fetchAllLogs = async (offset = 0, limit = 40) => {
        const response = await fetch(`${API_BASE}/logs?offset=${offset}&limit=${limit}`);
        return response.json();
    };
    const fetchAllUsers = async () => {
        const response = await fetch(`${API_BASE}/logs/user`);
        return response.json();
    };
    const fetchAllMachines = async () => {
        const response = await fetch(`${API_BASE}/logs/machine`);
        return response.json();
    };
    const fetchLogsByUser = async (username, offset = 0, limit = 40) => {
        const response = await fetch(`${API_BASE}/logs/user/${username}?offset=${offset}&limit=${limit}`);
        return response.json();
    };
    const fetchLogsByMachine = async (machine, offset = 0, limit = 40) => {
        const response = await fetch(`${API_BASE}/logs/machine/${machine}?offset=${offset}&limit=${limit}`);
        return response.json();
    };
    const fetchLogsByDate = async (start, end, offset = 0, limit = 40) => {
        const response = await fetch(`${API_BASE}/logs/date?start=${start}&end=${end}&offset=${offset}&limit=${limit}`);
        return response.json();
    };

    // קומפוננט ראשי
    function KeyloggerDashboard() {
        const [logs, setLogs] = useState([]);
        const [users, setUsers] = useState([]);
        const [machines, setMachines] = useState([]);
        const [loading, setLoading] = useState(true);
        const [selectedUser, setSelectedUser] = useState('');
        const [selectedMachine, setSelectedMachine] = useState('');
        const [startDate, setStartDate] = useState('');
        const [endDate, setEndDate] = useState('');
        const [searchText, setSearchText] = useState('');
        const [currentPage, setCurrentPage] = useState(0);
        const [selectedLog, setSelectedLog] = useState(null);
        
        // KPIs
        const [totalLogsCount, setTotalLogsCount] = useState(0);
        const [mostActiveUser, setMostActiveUser] = useState({ name: '-', count: 0 });
        const [lastActivity, setLastActivity] = useState('-');

        const ITEMS_PER_PAGE = 25;

        // טעינת נתונים וחישובים
        const loadData = async (page = 0) => {
            try {
                if (page === 0 && logs.length === 0) setLoading(true); // Only show main loader on first load

                // Fetch data
                const [logsResponse, usersData, machinesData] = await Promise.all([
                    fetchAllLogs(page * ITEMS_PER_PAGE, ITEMS_PER_PAGE),
                    fetchAllUsers(),
                    fetchAllMachines()
                ]);

                const logsData = logsResponse.logs || [];
                setLogs(logsData);
                setTotalLogsCount(logsResponse.total || logsData.length);
                setUsers(usersData.usernames || []);
                setMachines(machinesData.machines || []);
                
                // Calculate KPIs
                if(logsData.length > 0) {
                    const userCounts = logsData.reduce((acc, log) => {
                        acc[log.username] = (acc[log.username] || 0) + 1;
                        return acc;
                    }, {});

                    if(Object.keys(userCounts).length > 0) {
                        const mostActive = Object.entries(userCounts).reduce((a, b) => a[1] > b[1] ? a : b);
                        setMostActiveUser({ name: mostActive[0], count: mostActive[1] });
                    }
                    
                    const latestLog = logsData[0];
                    const timeDiff = Date.now() - new Date(latestLog.timestamp).getTime();
                    const minutesAgo = Math.floor(timeDiff / 60000);
                    setLastActivity(minutesAgo < 1 ? 'כרגע' : `לפני ${minutesAgo} דקות`);
                }

            } catch (error) {
                console.error('Error fetching data:', error);
            } finally {
                setLoading(false);
            }
        };

        useEffect(() => {
            loadData();
            const interval = setInterval(() => loadData(currentPage), 30000); // Refresh every 30 seconds
            return () => clearInterval(interval);
        }, [currentPage]);


        const handleFilter = async () => {
            setLoading(true);
            setCurrentPage(0);
            try {
                let response;
                if (selectedUser) response = await fetchLogsByUser(selectedUser, 0, ITEMS_PER_PAGE);
                else if (selectedMachine) response = await fetchLogsByMachine(selectedMachine, 0, ITEMS_PER_PAGE);
                else if (startDate && endDate) {
                    const start = Math.floor(new Date(startDate).getTime() / 1000);
                    const end = Math.floor(new Date(endDate).getTime() / 1000) + 86399; // End of day
                    response = await fetchLogsByDate(start, end, 0, ITEMS_PER_PAGE);
                } else {
                    response = await fetchAllLogs(0, ITEMS_PER_PAGE);
                }
                
                let filteredData = response.logs || [];
                if (searchText) {
                    filteredData = filteredData.filter(log =>
                        log.keylog.toLowerCase().includes(searchText.toLowerCase())
                    );
                }
                setLogs(filteredData);
                setTotalLogsCount(response.total || filteredData.length);
            } catch (error) {
                console.error("Error filtering data:", error);
            } finally {
                setLoading(false);
            }
        };
        
        const resetFilters = () => {
            setSelectedUser('');
            setSelectedMachine('');
            setStartDate('');
            setEndDate('');
            setSearchText('');
            setCurrentPage(0);
            loadData();
        };

        const getOSIcon = (machine) => {
            if (!machine) return <i className="bi bi-question-circle os-icon" title="Unknown OS"></i>;
            const lowerMachine = machine.toLowerCase();
            if (lowerMachine.includes('windows')) return <i className="bi bi-windows os-icon" title={machine}></i>;
            if (lowerMachine.includes('mac') || lowerMachine.includes('apple')) return <i className="bi bi-apple os-icon" title={machine}></i>;
            if (lowerMachine.includes('linux')) return <i className="bi bi-ubuntu os-icon" title={machine}></i>;
            return <i className="bi bi-pc-display-horizontal os-icon" title={machine}></i>;
        };

        const formatDate = (timestamp) => {
            return new Date(timestamp).toLocaleString('he-IL', { dateStyle: 'short', timeStyle: 'short' });
        };

        return (
            <div className="container-fluid p-4">
                {/* Header */}
                <header className="dashboard-header d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 className="h3 mb-0">Keylogger Dashboard</h1>
                        <p className="text-body-secondary mb-0">ניטור וניתוח הקלדות סוכנים</p>
                    </div>
                    <div>
                        <span className="badge text-bg-success">● Live</span>
                    </div>
                </header>

                {/* KPI Cards */}
                <div className="row g-3 mb-4">
                    <div className="col">
                        <div className="card kpi-card p-3">
                            <div className="kpi-content">
                                <div className="kpi-icon"><i className="bi bi-journal-text"></i></div>
                                <div className="kpi-label">סה"כ לוגים</div>
                                <div className="kpi-value">{loading && totalLogsCount === 0 ? '...' : totalLogsCount.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    <div className="col">
                         <div className="card kpi-card p-3">
                            <div className="kpi-content">
                                <div className="kpi-icon"><i className="bi bi-people-fill"></i></div>
                                <div className="kpi-label">סה"כ יעדים</div>
                                <div className="kpi-value">{loading && users.length === 0 ? '...' : users.length}</div>
                            </div>
                        </div>
                    </div>
                    <div className="col">
                        <div className="card kpi-card p-3">
                            <div className="kpi-content">
                                <div className="kpi-icon"><i className="bi bi-person-check-fill"></i></div>
                                <div className="kpi-label">היעד הפעיל ביותר</div>
                                <div className="kpi-value">{loading && mostActiveUser.name === '-' ? '...' : mostActiveUser.name}</div>
                            </div>
                        </div>
                    </div>
                    <div className="col">
                         <div className="card kpi-card p-3">
                            <div className="kpi-content">
                                <div className="kpi-icon"><i className="bi bi-clock-history"></i></div>
                                <div className="kpi-label">פעילות אחרונה</div>
                                <div className="kpi-value">{loading && lastActivity === '-' ? '...' : lastActivity}</div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Filtering & Table Card */}
                <div className="card">
                    <div className="card-header">
                        <div className="row g-2 align-items-center">
                            <div className="col-md-2">
                                <select className="form-select form-select-sm" value={selectedUser} onChange={(e) => setSelectedUser(e.target.value)}>
                                    <option value="">סינון לפי משתמש</option>
                                    {users.map(user => <option key={user} value={user}>{user}</option>)}
                                </select>
                            </div>
                            <div className="col-md-3">
                                <select className="form-select form-select-sm" value={selectedMachine} onChange={(e) => setSelectedMachine(e.target.value)}>
                                    <option value="">סינון לפי מכונה</option>
                                    {machines.map(machine => <option key={machine} value={machine}>{machine}</option>)}
                                </select>
                            </div>
                            <div className="col-md-2">
                                <input type="date" className="form-control form-control-sm" value={startDate} onChange={(e) => setStartDate(e.target.value)} />
                            </div>
                             <div className="col-md-2">
                                <input type="date" className="form-control form-control-sm" value={endDate} onChange={(e) => setEndDate(e.target.value)} />
                            </div>
                            <div className="col-md-3">
                                <input type="search" className="form-control form-control-sm" placeholder="חיפוש טקסט בתוכן..." value={searchText} onChange={(e) => setSearchText(e.target.value)} />
                            </div>
                        </div>
                         <div className="row mt-2">
                            <div className="col-12">
                                <button className="btn text-bg-success btn-sm me-2" onClick={handleFilter}><i className="bi bi-search me-1"></i> החל סינונים</button>
                                <button className="btn btn-outline-secondary btn-sm" onClick={resetFilters}><i className="bi bi-arrow-clockwise me-1"></i> אפס</button>
                            </div>
                        </div>
                    </div>
                    <div className="card-body p-0">
                        {/* FIX 2 HERE: Added the wrapper div */}
                        <div className="table-wrapper">
                            <div className="table-responsive">
                                <table className="table table-hover logs-table mb-0">
                                    <thead>
                                        <tr>
                                            <th>זמן</th>
                                            <th>שם היעד</th>
                                            <th>מערכת הפעלה</th>
                                            <th>תוכן ההקלדה</th>
                                            <th className="text-end">פרטים נוספים</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {loading && logs.length === 0 ? (
                                            <tr><td colSpan="5" className="text-center p-5"><div className="spinner-border" role="status"><span className="visually-hidden">טוען...</span></div></td></tr>
                                        ) : logs.map(log => (
                                            <tr key={log.id}>
                                                <td className="text-nowrap text-body-secondary">{formatDate(log.timestamp)}</td>
                                                <td><span className="badge text-bg-info text-dark">{log.username}</span></td>
                                                <td>{getOSIcon(log.machine)} <small>{log.machine}</small></td>
                                                <td><div className="truncate font-monospace">{log.keylog}</div></td>
                                                <td className="text-end">
                                                    <button className="btn btn-sm btn-outline-light" onClick={() => setSelectedLog(log)}>
                                                        <i className="bi bi-eye"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                {/* Pagination */}

                {/* Log Details Modal */}
                {selectedLog && (
                    <div className="modal fade show d-block" tabIndex="-1" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
                        <div className="modal-dialog modal-lg modal-dialog-centered">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5 className="modal-title">פרטי לוג - {formatDate(selectedLog.timestamp)}</h5>
                                    <button type="button" className="btn-close" onClick={() => setSelectedLog(null)}></button>
                                </div>
                                <div className="modal-body">
                                    <div className="mb-3">
                                        <strong>משתמש:</strong> <span className="badge text-bg-info text-dark ms-2">{selectedLog.username}</span>
                                    </div>
                                    <div className="mb-3">
                                        <strong>מערכת הפעלה:</strong> <span className="ms-2">{getOSIcon(selectedLog.machine)} {selectedLog.machine}</span>
                                    </div>
                                    <div className="mb-3">
                                        <strong>תוכן מלא:</strong>
                                        <textarea 
                                            className="form-control mt-2 font-monospace" 
                                            rows="12" 
                                            readOnly 
                                            value={selectedLog.keylog}
                                            style={{ direction: 'ltr', textAlign: 'left' }}
                                        ></textarea>
                                    </div>
                                </div>
                                <div className="modal-footer">
                                    <button type="button" className="btn btn-secondary" onClick={() => setSelectedLog(null)}>סגור</button>
                                    <button type="button" className="btn btn-primary" onClick={() => navigator.clipboard.writeText(selectedLog.keylog)}>
                                       <i className="bi bi-clipboard me-1"></i> העתק תוכן
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<KeyloggerDashboard />);
  </script>
</body>
</html>